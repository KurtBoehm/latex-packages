%% QrCode.sty, which is part of https://github.com/KurtBoehm/latex-packages
%% Copyright 2026 Kurt Böhm
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   https://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2008 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Kurt Böhm.

\RequirePackage{l3keys2e}
\ProvidesExplPackage{packages/QrCode}{2026-01-05}{1.2}{TikZ QR Codes}
\RequirePackage{tikz}
\RequirePackage{packages/UnixTime}

% Initialize/update if polyqr_tikz does not exist or is more than 24 hours old
\cs_new:Nn\semco_venv_init:{
  \sys_shell_now:n{rm ~ -rf ~ .qrcode}
  \sys_shell_now:n{python3 ~ -m ~ venv ~ .qrcode}
  \sys_shell_now:n{./.qrcode/bin/pip3 ~ install ~ polyqr}
}
\file_if_exist:nTF{.qrcode/bin/polyqr_tikz}{
  \int_new:N\g_qrcode_age_int
  \unixtime_file_age:nN{.qrcode/bin/polyqr_tikz}\g_qrcode_age_int
  \tl_log:e{polyqr_tikz~age:~\int_use:N\g_qrcode_age_int}
  \int_compare:nT{\g_qrcode_age_int > 86400}{\semco_venv_init:}
}{\semco_venv_init:}

\sys_shell_now:n{echo ~ "*" ~ > ~ .qrcode/.gitignore}

\cs_generate_variant:Nn\sys_get_shell:nnN{enN}

% #1: with a star, #2 is the QR code size, otherwise it is the module size
% #2: the module/full size of the QR code
% #3: the message to be represented by the QR code
% #4: additional style specifications that apply to each area of the QR code
\NewDocumentCommand{\QrCode}{s m m O{}}{
  \sys_get_shell:enN{.qrcode/bin/polyqr_tikz~\IfBooleanT{#1}{--full-size}~#2~'#4'~#3}{}\g_tmpa_tl
  \tl_use:N\g_tmpa_tl
}
