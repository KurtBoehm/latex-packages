%% Env.sty, which is part of https://github.com/KurtBoehm/latex-packages
%% Copyright 2026 Kurt Böhm
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   https://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2008 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Kurt Böhm.

\RequirePackage{expl3}
\ProvidesExplPackage{packages/Env}{2024-11-14}{1.0}{Access environment variables}

% Based on https://tex.stackexchange.com/a/62032

% #1: The environment variable to query
% #2: The destination LaTeX3 tl variable
% Query #1 using kpsewhich and stores the result in #2.
\cs_new:Nn\env_query_raw:nN{\sys_get_shell:nnN{kpsewhich ~ --var-value ~ #1}{}#2}

% #1: The environment variable to query
% #2: The destination LaTeX3 tl variable
% Query #1, which is assumed to result in a path, using kpsewhich and stores the result in #2.
\cs_new:Nn\env_query_path:nN{%
  \env_query_raw:nN{#1}#2%
  \tl_trim_spaces:N#2%
  \tl_if_empty:NTF#2{\tl_set:Nn#2{.}}{%
    \tl_if_eq:NnT#2{\par}{\tl_set:Nn#2{.}}%
  }%
}
% #1: The destination LaTeX3 tl variable
% Store the output directory in #1.
\cs_new:Nn\env_query_path:N{\env_query_path:nN{TEXMF_OUTPUT_DIRECTORY}#1}

\NewDocumentCommand{\GetOutputDir}{o}{%
  \env_query_path:N\l_tmpa_tl%
  \IfNoValueTF{#1}{\tl_use:N\l_tmpa_tl}{\tl_set_eq:NN#1\l_tmpa_tl}%
}
